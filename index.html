<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rechaj Kat Vityèl — Peman</title>

  <!-- Tailwind via CDN for quick styling (optional) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { -webkit-font-smoothing:antialiased; }
    .field-label { font-weight:600; }
    .card { border-radius:1rem; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">

  <main class="w-full max-w-2xl bg-white p-6 card">
    <h1 class="text-2xl font-bold mb-4">Fòm Peman — Rechaj Kat Vityèl</h1>

    <form id="paymentForm" class="space-y-4">
      <div>
        <label class="field-label block">Non konplè</label>
        <input name="fullname" id="fullname" required class="w-full p-2 border rounded" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="field-label block">WhatsApp (eg: 509XXXXXXXX)</label>
          <input name="whatsapp" id="whatsapp" required class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="field-label block">Nimewo Apèl</label>
          <input name="phone" id="phone" required class="w-full p-2 border rounded" />
        </div>
      </div>

      <div>
        <label class="field-label block">Imèl</label>
        <input type="email" name="email" id="email" class="w-full p-2 border rounded" />
      </div>

      <div>
        <label class="field-label block">Nimewo Kat (pou rechaj kat vityèl)</label>
        <input name="cardNumber" id="cardNumber" placeholder="eg: 1234-5678-9012" class="w-full p-2 border rounded" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="field-label block">Montan (siveye)</label>
          <input type="number" step="0.01" min="0" name="amount" id="amount" required class="w-full p-2 border rounded" />
        </div>

        <div>
          <label class="field-label block">Lajan (ex: HTG, USD)</label>
          <input name="currency" id="currency" value="HTG" class="w-full p-2 border rounded" />
        </div>

        <div>
          <label class="field-label block">Taux du jour (eg: 1 USD = X HTG)</label>
          <input type="number" step="0.01" name="taux" id="taux" value="1" class="w-full p-2 border rounded" />
        </div>
      </div>

      <div>
        <label class="field-label block">Metòd Peman</label>
        <select id="method" class="w-full p-2 border rounded">
          <option value="Cash">Cash</option>
          <option value="Natcash">Natcash</option>
        </select>
      </div>

      <div class="flex items-center gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Kreye Lyen Peman & Reçu</button>
        <button id="clearBtn" type="button" class="px-4 py-2 bg-gray-200 rounded">Efase</button>
      </div>
    </form>

    <!-- Rezilta -->
    <div id="result" class="mt-6 hidden p-4 border rounded bg-gray-50">
      <h2 class="font-bold mb-2">Enfòmasyon Peman</h2>
      <div id="paymentSummary" class="text-sm space-y-1"></div>

      <div class="mt-3 flex gap-3">
        <a id="paymentLink" target="_blank" class="px-3 py-2 bg-green-600 text-white rounded hidden">Lyen Peman</a>
        <a id="waLink" target="_blank" class="px-3 py-2 bg-sky-600 text-white rounded hidden">Voye Whatsapp</a>
        <a id="callLink" class="px-3 py-2 bg-gray-700 text-white rounded hidden">Rele</a>
        <button id="downloadPdf" class="px-3 py-2 bg-indigo-600 text-white rounded hidden">Telechaje Reçu (PDF)</button>
      </div>
    </div>

    <footer class="mt-6 text-xs text-gray-500">
      Enstwi: Le lien peman la se yon fason pou kolekte enfòmasyon — pou pwosesis lajan an, swiv enstriksyon Cash/Natcash tankou konpayi w ap itilize yo.
    </footer>
  </main>

  <script>
    // IIFE pou evite polisyon global
    (function () {
      const form = document.getElementById('paymentForm');
      const resultBox = document.getElementById('result');
      const paymentSummary = document.getElementById('paymentSummary');
      const paymentLinkEl = document.getElementById('paymentLink');
      const waLinkEl = document.getElementById('waLink');
      const callLinkEl = document.getElementById('callLink');
      const downloadPdfBtn = document.getElementById('downloadPdf');
      const clearBtn = document.getElementById('clearBtn');

      function generateReference() {
        const ts = Date.now().toString(36).toUpperCase();
        return 'REF-' + ts.slice(-8);
      }

      function formatNumber(n) {
        return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      }

      function buildPaymentURL(data) {
        // Use current origin+pathname so link works after hosting (GitHub Pages)
        const base = window.location.origin + window.location.pathname;
        const params = new URLSearchParams({
          ref: data.ref,
          name: data.fullname,
          card: data.cardNumber || '',
          amount: data.amount,
          currency: data.currency,
          taux: data.taux,
          method: data.method,
          whatsapp: data.whatsapp || '',
          phone: data.phone || '',
          email: data.email || ''
        });
        return base + '?' + params.toString();
      }

      function createWhatsappURL(data, paymentUrl) {
        // Pre-fill message for payer to send as proof
        const phone = data.whatsapp.replace(/\D/g,''); // raw digits
        const message = `Mwen fè peman:\nRef: ${data.ref}\nNon: ${data.fullname}\nMontan: ${formatNumber(data.amount)} ${data.currency}\nMetòd: ${data.method}\nKat: ${data.cardNumber || '-'}\nLyen pou verifye: ${paymentUrl}`;
        // wa.me requires country code + number; if missing, user can still click and paste
        const phoneForLink = phone || ''; // if empty, use wa.me without number will fail, so link will be blank and we show anyway
        const encoded = encodeURIComponent(message);
        if (phoneForLink) return `https://wa.me/${phoneForLink}?text=${encoded}`;
        return `https://wa.me/?text=${encoded}`;
      }

      async function generatePdf(data) {
        // Using jsPDF to create a simple receipt PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });
        const left = 15; let y = 20;
        doc.setFontSize(16);
        doc.text('REÇU DE PAIEMENT', 105, y, { align: 'center' });
        y += 10;
        doc.setFontSize(11);
        doc.text(`Référence: ${data.ref}`, left, y); y += 8;
        doc.text(`Date: ${new Date(data.date).toLocaleString()}`, left, y); y += 8;
        doc.text(`Nom: ${data.fullname}`, left, y); y += 8;
        doc.text(`WhatsApp: ${data.whatsapp}   Téléfòn: ${data.phone}`, left, y); y += 8;
        if (data.email) { doc.text(`Email: ${data.email}`, left, y); y += 8; }
        doc.text(`Kat / Nimewo: ${data.cardNumber || '-'}`, left, y); y += 8;
        doc.text(`Montan: ${formatNumber(data.amount)} ${data.currency}`, left, y); y += 8;
        doc.text(`Taux du jour: ${formatNumber(data.taux)}`, left, y); y += 8;
        if (data.currency.toUpperCase() !== 'HTG') {
          // show equivalent in HTG
          const htgeq = Number(data.amount) * Number(data.taux || 1);
          doc.text(`Équivalent HTG: ${formatNumber(htgeq)} HTG`, left, y); y += 8;
        }
        doc.text(`Méthode: ${data.method}`, left, y); y += 14;
        doc.setFontSize(10);
        doc.text('Mèsi paske ou itilize sèvis nou an.', left, y);
        doc.save(`recu_${data.ref}.pdf`);
      }

      function showResult(data, paymentUrl, waUrl) {
        paymentSummary.innerHTML = `
          <div><strong>Réf:</strong> ${data.ref}</div>
          <div><strong>Nom:</strong> ${data.fullname}</div>
          <div><strong>Montan:</strong> ${formatNumber(data.amount)} ${data.currency}</div>
          <div><strong>Taux:</strong> ${formatNumber(data.taux)}</div>
          <div><strong>Méthode:</strong> ${data.method}</div>
        `;
        paymentLinkEl.href = paymentUrl;
        paymentLinkEl.textContent = 'Ouvri/Verifye Lyen Peman';
        paymentLinkEl.classList.remove('hidden');

        waLinkEl.href = waUrl;
        waLinkEl.classList.remove('hidden');

        callLinkEl.href = 'tel:' + (data.phone || '');
        callLinkEl.textContent = 'Rele ' + (data.phone || '');
        callLinkEl.classList.remove('hidden');

        downloadPdfBtn.classList.remove('hidden');
        resultBox.classList.remove('hidden');
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Collect data
        const data = {
          fullname: document.getElementById('fullname').value.trim(),
          whatsapp: document.getElementById('whatsapp').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          email: document.getElementById('email').value.trim(),
          cardNumber: document.getElementById('cardNumber').value.trim(),
          amount: document.getElementById('amount').value.trim(),
          currency: document.getElementById('currency').value.trim() || 'HTG',
          taux: document.getElementById('taux').value.trim() || '1',
          method: document.getElementById('method').value,
          date: new Date().toISOString(),
          ref: generateReference()
        };

        // Basic validation
        if (!data.fullname || !data.amount) {
          alert('Ranpli non ak montan souple.');
          return;
        }

        // Compute payment URL and whatsapp link
        const paymentUrl = buildPaymentURL(data);
        const waUrl = createWhatsappURL(data, paymentUrl);

        // Save data in localStorage for simple persistence (optional)
        const key = 'payments_history';
        try {
          const hist = JSON.parse(localStorage.getItem(key) || '[]');
          hist.unshift(data);
          localStorage.setItem(key, JSON.stringify(hist.slice(0,50))); // keep last 50
        } catch (err) { console.warn('localStorage err', err); }

        // Show results & links
        showResult(data, paymentUrl, waUrl);

        // Attach download action
        downloadPdfBtn.onclick = function () {
          generatePdf(data);
        };

        // Also create a visible short copyable link text
        paymentLinkEl.onclick = function (ev) {
          // default opens in new tab; nothing extra needed
        };

        // Smooth scroll to result
        resultBox.scrollIntoView({ behavior: 'smooth' });
      });

      clearBtn.addEventListener('click', function () {
        form.reset();
        resultBox.classList.add('hidden');
        paymentLinkEl.classList.add('hidden');
        waLinkEl.classList.add('hidden');
        callLinkEl.classList.add('hidden');
        downloadPdfBtn.classList.add('hidden');
      });

      // If page opened with params (someone clicked payment link), prefill & highlight
      function prefillFromQuery() {
        const q = new URLSearchParams(window.location.search);
        if (!q.toString()) return;
        const map = {
          ref: 'ref',
          name: 'fullname',
          card: 'cardNumber',
          amount: 'amount',
          currency: 'currency',
          taux: 'taux',
          method: 'method',
          whatsapp: 'whatsapp',
          phone: 'phone',
          email: 'email'
        };
        let filled = false;
        Object.entries(map).forEach(([k, field]) => {
          const v = q.get(k);
          if (v !== null) {
            const el = document.getElementById(field);
            if (el) { el.value = decodeURIComponent(v); filled = true; }
          }
        });
        if (filled) {
          // small visual cue
          const note = document.createElement('div');
          note.className = 'mt-4 p-2 bg-yellow-100 border rounded text-sm';
          note.textContent = 'Fòm ranpli otomatik ak enfòmasyon sou peman. Verifye epi klike "Kreye Lyen Peman & Reçu".';
          form.prepend(note);
        }
      }

      prefillFromQuery();

    })();
  </script>
</body>
</html>
